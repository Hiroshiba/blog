<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="この記事はChainer Advent Calendar 2017の23日目の記事です。僕は普段、Chainerを使って研究開発しています。このとき、クラスをどう分けるべきかよく悩みます。いろいろやってみてある程度固まってきたので、自分なりにまとめてみました。">
  <meta name="keyword" content="">
  
    <link rel="shortcut icon" type="image/ico" href="/images/favicon.png"/>
  
  <title>Chainerを使った研究開発時のクラス設計 | Hiho&#39;s Blog</title>
  <meta name="description" content="この記事はChainer Advent Calendar 2017の23日目の記事です。僕は普段、Chainerを使って研究開発しています。このとき、クラスをどう分けるべきかよく悩みます。いろいろやってみてある程度固まってきたので、自分なりにまとめてみました。">
<meta property="og:type" content="article">
<meta property="og:title" content="Chainerを使った研究開発時のクラス設計">
<meta property="og:url" content="http://blog.hiroshiba.jp/class-design-at-research-and-development-using-chainer/index.html">
<meta property="og:site_name" content="Hiho&#39;s Blog">
<meta property="og:description" content="この記事はChainer Advent Calendar 2017の23日目の記事です。僕は普段、Chainerを使って研究開発しています。このとき、クラスをどう分けるべきかよく悩みます。いろいろやってみてある程度固まってきたので、自分なりにまとめてみました。">
<meta property="article:published_time" content="2017-12-22T19:14:42.000Z">
<meta property="article:modified_time" content="2018-02-12T03:44:59.900Z">
<meta property="article:author" content="Kazuyuki Hiroshiba">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@hiho_karuta">
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/a11y-dark.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-141253083-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-141253083-1');
    </script>

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Hiho's Blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="https://twitter.com/hiho_karuta" target="_blank" rel="noopener" class="item-link">Twitter</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="https://github.com/Hiroshiba" target="_blank" rel="noopener" class="item-link">Github</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="https://twitter.com/hiho_karuta" target="_blank" rel="noopener" class="menu-link">Twitter</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="https://github.com/Hiroshiba" target="_blank" rel="noopener" class="menu-link">Github</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>Chainerを使った研究開発時のクラス設計</h2>
  <p class="post-date">2017-12-23</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>この記事は<a href="https://qiita.com/advent-calendar/2017/chainer" target="_blank" rel="noopener">Chainer Advent Calendar 2017</a>の23日目の記事です。</p>
<p>僕は普段、Chainerを使って研究開発しています。
このとき、クラスをどう分けるべきかよく悩みます。
いろいろやってみてある程度固まってきたので、自分なりにまとめてみました。</p>
<a id="more"></a>

<p>ChainerなどのDeepLearningフレームワークを使う理由は大きく分けて３段階ほどあります。</p>
<ol>
<li>再現実験</li>
<li>試行錯誤を伴う実験</li>
<li>学習済みモデルを用いたシステムづくり</li>
</ol>
<p>世の中に転がっているChainerサンプルプログラムは大体(1)のもので、こちらは綺麗にまとまっているものが多いです。
一方で、何か新規に実験していると、どうしても試行錯誤が発生してコードが煩雑になります(2)。
そしてさらには、(1)や(2)で学習したモデルを使ってサービス応用しようとすることもあります(3)。</p>
<p>今回は研究開発用のコード、つまり、サービス応用を考えつつ実験コードを書く際に、どうクラスを切っていくべきか考えをまとめます。</p>
<hr>
<p>まず、細かいのも含めると、実験コードには次の構成要素があります。</p>
<ul>
<li>DataProcess : 入力・出力データの加工する</li>
<li>Dataset : データをChainer用にまとめる</li>
<li>Network : 汎用のニューラルネットワーク</li>
<li>Loss : 損失の取り回し</li>
<li>Model : ニューラルネットワーク全体</li>
<li>Updater : モデルの更新（＋データの取り回し）</li>
<li>Trainer : 便利モジュールとの連携</li>
</ul>
<p>規模や実験内容に応じて<code>DataProcess</code>は<code>Dataset</code>に、<code>Network</code>と<code>Loss</code>は<code>Model</code>にまとめることもあります。
このうち、学習済みモデルを用いたサービスを作る際に必要なのは、<code>DataProcess</code>と<code>Model</code>だけです。</p>
<p>それぞれに関して、なんなのか、なぜそれが必要か、どういうときに必要かを書きます。</p>
<hr>
<h2 id="DataProcess"><a href="#DataProcess" class="headerlink" title="DataProcess"></a>DataProcess</h2><p>入力データや出力データを加工する関数、もしくは呼び出し可能なオブジェクトです。
画像を読み出す、クロップする、線画化する、などなど。
これらのデータ処理は、<strong><code>DatasetMixin</code>オブジェクトの<code>get_example</code>メソッドに書くこともできますが、こうしてしまうとあとで流用する際にそのオブジェクトの構造を意識する必要が出てきます。</strong>
例えば１枚の画像を加工したいだけでも、<code>DatasetMixin</code>オブジェクトを作成し、<code>get_example(0)</code>しなければいけません。
最初からデータを加工する関数を切り出しておけば、後で簡単に流用できます。</p>
<h2 id="Dataset"><a href="#Dataset" class="headerlink" title="Dataset"></a>Dataset</h2><p>データをChainer用にまとめるクラスです。<code>DatasetMixin</code>を継承して作るのが一般的です。
<code>DataProcess</code>にも書いたとおり、<strong>ここに記述した処理は後で流用しづらいので、なるべく簡単なことしか書かないほうが良い</strong>と思います。
僕は<code>DataProcess</code>を１つだけ受け取ってデータ加工する<code>Dataset</code>クラスをよく使っています。</p>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dataset</span><span class="hljs-params">(chainer.dataset.DatasetMixin)</span>:</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, inputs, data_process)</span>:</span>
    self._inputs = inputs
    self._data_process = data_process

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__len__</span><span class="hljs-params">(self)</span>:</span>
    <span class="hljs-keyword">return</span> len(self._inputs)

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_example</span><span class="hljs-params">(self, i)</span>:</span>
    <span class="hljs-keyword">return</span> self._data_process(self._inputs[i])</code></pre>

<h2 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h2><p>汎用のネットワークを書きます。簡単なモデルの場合はなくても良いと思います。
僕はよくBatchNormalizationとConvolution2Dをまとめたのを流用しています。</p>
<pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BNConvolution2D</span><span class="hljs-params">(chainer.link.Chain)</span>:</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, in_channels, out_channels, ksize, stride=<span class="hljs-number">1</span>, pad=<span class="hljs-number">0</span>, **kwargs)</span>:</span>
    super().__init__()
    <span class="hljs-keyword">with</span> super().init_scope():
      self.conv = chainer.links.Convolution2D(in_channels, out_channels, ksize, stride, pad, nobias=<span class="hljs-literal">True</span>, **kwargs)
      self.bn = chainer.links.BatchNormalization(out_channels)

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span><span class="hljs-params">(self, x)</span>:</span>
    <span class="hljs-keyword">return</span> chainer.functions.relu(self.bn(self.conv(x)))</code></pre>

<h2 id="Loss"><a href="#Loss" class="headerlink" title="Loss"></a>Loss</h2><p>損失関数を実装します。簡単なモデルの場合はなくても良いと思います。
Chainerの<code>Trainer</code>とloss周りの扱いはややこしく、<code>chainer.report</code>を使ったりする必要があります。
<strong><code>Loss</code>クラスの書き方は<a href="https://github.com/chainer/chainer/blob/4ce120d09b6543ae60a6d18830b4345992f1322d/chainer/links/model/classifier.py" target="_blank" rel="noopener">chainer.links.Classifier</a>がとても参考になります。</strong>
コンストラクタで<code>Model</code>オブジェクトを受け取って<code>__call__</code>でフォワードし、得られた出力を元にlossを作ってreturnする設計です。
<strong><code>Loss</code>クラスが必要になるのはモデルが２種類以上あるとき</strong>です。DCGANなどのタスクでは<code>Loss</code>クラスを作って、生成器と判別器用のlossを返すと綺麗にコードが書けます。</p>
<h2 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h2><p>ニューラルネットワークをまとめたクラスです。
<strong><code>Optimizer</code>１つにつき<code>Model</code>１つ</strong>と考えると理解しやすいです。
<code>chainer.link.Chain</code>や<code>chainer.link.ChainList</code>を継承して書くのが一般的です。</p>
<h2 id="Updater"><a href="#Updater" class="headerlink" title="Updater"></a>Updater</h2><p>こいつがむちゃくちゃしんどいです。
<code>Model</code>が１つしかなければ<code>chainer.training.StandardUpdater</code>を使うと大体うまく行きます。
<code>Model</code>が複数ある場合、<code>StandardUpdater</code>を継承した<code>Updater</code>クラスを自分で定義し、データの流れとモデルの更新を自分で書く必要があります。
<a href="https://github.com/chainer/chainer/blob/7d0d6e70aab9763727802e2a8524744687e9086d/examples/dcgan/updater.py#L10" target="_blank" rel="noopener">DCGANのサンプル実装</a>でちょっと雰囲気がつかめると思います。
<code>Loss</code>クラスをうまく切り出せてさえいればある程度綺麗に書けます。</p>
<h2 id="Trainer"><a href="#Trainer" class="headerlink" title="Trainer"></a>Trainer</h2><p>Chainerが用意した学習用のクラスです。
<code>Updater</code>や<code>Model</code>を与えるとよしなに色々やってくれます。
これに関してはいろんな記事があるので説明は割愛します。</p>
<hr>
<p>これらの方式で実験コードを書くと、ある程度煩雑になってきても大規模な改修は発生しづらくなります。
また、<code>DataProcess</code>と<code>Model</code>をライブラリ化すれば、サービス応用も比較的簡単に行なえます。</p>
<p>Chainerは柔軟でいろんなクラス設計が可能です。
試行錯誤を伴う実験をしていてもコードが散らばらないような設計があれば、ぜひ教えてください。
開発方針を自分の中で持っておいて、どんどん研究開発していきたいものです。</p>
</section>
    <!-- Tags START -->
    
    <!-- Tags END -->
    <!-- Share Button START -->
    <ul class="share-list">
      <li>
        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" target="_blank" rel="noopener" class="twitter-share-button" data-via="hiho_karuta" data-related="hiho_karuta" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
      </li>
      <li>
        <a href="http://b.hatena.ne.jp/entry/" target="_blank" rel="noopener" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
      </li>
      <li>
        <div id="fb-root"></div><script async defer crossorigin="anonymous" src="https://connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v3.3&appId=411014156399099&autoLogAppEvents=1"></script><div class="fb-share-button" data-href="http://blog.hiroshiba.jp/class-design-at-research-and-development-using-chainer/" data-layout="button_count" data-size="small"><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fblog.hiroshiba.jp%2Fclass-design-at-research-and-development-using-chainer%2F&amp;src=sdkpreparse" class="fb-xfbml-parse-ignore">facebookでシェア</a></div>
      </li>
    </ul>
    <!-- Share Button END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/voice-conversion-deep-leanring-and-other-delusions/">
        <span class="nav-arrow">← </span>
        
          DeepLearningでも声質変換したい！
        
      </a>
    
    
      <a class="nav-right" href="/became-yuduki-yukari-with-deep-learning-power/">
        
          ディープラーニングの力で結月ゆかりの声になってみた
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://blog.hiroshiba.jp/class-design-at-research-and-development-using-chainer/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2021 Hiroshiba Kazuyuki
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>


<script src="/js/script.js"></script>


  </body>
</html>